@page "/pensum"
@* --- Using Statements --- *@
@using TaekwondoApp.Shared.DTO
@using TaekwondoApp.Shared.Models
@using TaekwondoApp.Shared.Services
@using TaekwondoApp.Shared.Helper
@using AutoMapper
@using Microsoft.AspNetCore.SignalR.Client

@* --- Dependency Injection --- *@
@inject NavigationManager NavigationManager
@inject IMapper _mapper
@inject IHttpClientFactory HttpClientFactory
@inject AuthStateProvider AuthStateProvider
@inject IAuthenticationService AuthenticationService

<h1>Pensum Management</h1>

<input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Search Pensum, Teknik, or Teori..." class="form-control mb-3" />

@if (filteredPensums == null)
{
    <p><em>Loading...</em></p>
}
else if (filteredPensums.Length == 0)
{
    <p><em>No pensum data available.</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Pensum Grad</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var pensum in filteredPensums)
            {
                <tr>
                    <td>@pensum.PensumGrad</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" @onclick="() => ToggleExpand(pensum.PensumID)">
                            @(expandedPensums.Contains(pensum.PensumID) ? "Hide Details" : "Show Details")
                        </button>
                    </td>
                </tr>

                @if (expandedPensums.Contains(pensum.PensumID))
                {
                    <tr>
                        <td colspan="3">
                            <div>
                                <h5>Teknik:</h5>
                                @if (pensum.Teknik.Count == 0)
                                {
                                    <p><em>No teknik found.</em></p>
                                }
                                else
                                {
                                    @foreach (var teknik in pensum.Teknik
                                   .Where(t => string.IsNullOrWhiteSpace(searchTerm) || t.TeknikNavn.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
                                    {
                                        <div class="border p-2 mb-2 rounded">
                                            <h6>
                                                <a @onclick="() => NavigateToTeknik(teknik.TeknikID)" style="cursor:pointer;">
                                                    @teknik.TeknikNavn
                                                </a>
                                            </h6>
                                            <p><strong>Beskrivelse:</strong> @teknik.TeknikBeskrivelse</p>

                                            @if (!string.IsNullOrWhiteSpace(teknik.TeknikBillede))
                                            {
                                                <img src="@teknik.TeknikBillede" alt="Teknik Billede" class="img-thumbnail mb-2" style="max-width: 200px;" />
                                            }

                                            @if (!string.IsNullOrWhiteSpace(teknik.TeknikVideo))
                                            {
                                                <video controls class="mb-2" style="max-width: 300px;">
                                                    <source src="@teknik.TeknikVideo" type="video/mp4" />
                                                </video>
                                            }

                                            @if (!string.IsNullOrWhiteSpace(teknik.TeknikLyd))
                                            {
                                                <audio controls class="mb-2">
                                                    <source src="@teknik.TeknikLyd" type="audio/mpeg" />
                                                </audio>
                                            }
                                        </div>
                                    }
                                }

                                <h5>Teori:</h5>
                                @if (pensum.Teori.Count == 0)
                                {
                                    <p><em>No teori found.</em></p>
                                }
                                else
                                {
                                    @foreach (var teori in pensum.Teori
                                   .Where(t => string.IsNullOrWhiteSpace(searchTerm) || t.TeoriNavn.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
                                    {
                                        <div class="border p-2 mb-2 rounded">
                                            <h6>
                                                <a @onclick="() => NavigateToTeori(teori.TeoriID)" style="cursor:pointer;">
                                                    @teori.TeoriNavn
                                                </a>
                                            </h6>
                                            <p><strong>Beskrivelse:</strong> @teori.TeoriBeskrivelse</p>

                                            @if (!string.IsNullOrWhiteSpace(teori.TeoriBillede))
                                            {
                                                <img src="@teori.TeoriBillede" alt="Teori Billede" class="img-thumbnail mb-2" style="max-width: 200px;" />
                                            }

                                            @if (!string.IsNullOrWhiteSpace(teori.TeoriVideo))
                                            {
                                                <video controls class="mb-2" style="max-width: 300px;">
                                                    <source src="@teori.TeoriVideo" type="video/mp4" />
                                                </video>
                                            }

                                            @if (!string.IsNullOrWhiteSpace(teori.TeoriLyd))
                                            {
                                                <audio controls class="mb-2">
                                                    <source src="@teori.TeoriLyd" type="audio/mpeg" />
                                                </audio>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@if (errorMessage != null)
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

@code {
    private PensumDTO[] pensums;
    private PensumDTO[] filteredPensums;
    private string? errorMessage;
    private HttpClient _apiClient;
    private string searchTerm = "";
    private HashSet<Guid> expandedPensums = new();

    protected override async Task OnInitializedAsync()
    {
        _apiClient = HttpClientFactory.CreateClient("ApiClient");
        await LoadPensums();
    }

    private async Task LoadPensums()
    {
        try
        {
            var response = await _apiClient.GetFromJsonAsync<ApiResponse<List<PensumDTO>>>("api/Pensum");

            if (response != null && response.Success)
            {
                pensums = response.Data.ToArray();
                ApplyFilter();
            }
            else
            {
                errorMessage = "Failed to load data.";
                if (response?.Errors != null)
                    errorMessage += " Errors: " + string.Join(", ", response.Errors);
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error fetching data: " + ex.Message;
        }
    }

    private void ToggleExpand(Guid pensumId)
    {
        if (expandedPensums.Contains(pensumId))
            expandedPensums.Remove(pensumId);
        else
            expandedPensums.Add(pensumId);
    }

    private void NavigateToTeknik(Guid teknikId)
    {
        NavigationManager.NavigateTo($"/teknik/{teknikId}");
    }

    private void NavigateToTeori(Guid teoriId)
    {
        NavigationManager.NavigateTo($"/teori/{teoriId}");
    }

    private void ApplyFilter()
    {
        filteredPensums = pensums.Where(p =>
            string.IsNullOrWhiteSpace(searchTerm) ||
            p.PensumGrad.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
            p.Teknik.Any(t => t.TeknikNavn.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
            p.Teori.Any(t => t.TeoriNavn.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
        ).ToArray();
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        ApplyFilter();
    }

    private async Task OnSearchTermChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        ApplyFilter();
    }
}
